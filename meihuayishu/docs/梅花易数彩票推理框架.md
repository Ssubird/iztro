# 梅花易数彩票推理计算框架

本框架依据《梅花易数》的起卦与演卦原则，对现代彩票预测场景进行抽象。框架分为“起卦建模 → 卦象演化 → 数值解码 → 玩法适配 → 结果评估”五大阶段，并通过参数化组件兼容双色球、大乐透、快乐8等玩法。

## 0. 原典要点与校准依据（必读）

> “年月日为上卦，年月日加时总为下卦……以八除之，以零数作上卦。”——《梅花易数·年月日时起例》

> “以平分‘今日动’三字为上卦……共得八数，得坤为上卦。”——《梅花易数·今日动静如何》

> “五行生克：金生水，水生木……乾兑金；坤艮土；震巽木；坎水；离火。”——《梅花易数·五行生克》

结合原典，可提炼出驱动后续模块的核心规则：

* **起卦信息源**：支持“年、月、日、时”总数取卦与“音韵笔画”取卦两大体系，可通过配置切换；任何自动化流程都应保留两种算法的接口，以便对照原书例题。
* **动爻与互卦**：需记录主卦总数除六所得余数判动爻，并保留互卦（去首末两爻）的生成逻辑，乾坤本无互，须以变卦代之。
* **体用/用神体系**：原文强调“认定一笔作用神”，即以主事因素（求财、求名等）选取官鬼、财爻、父母等；现代预测需将“投注目标”映射到对应五行与六亲维度，保持体用分明。
* **五行旺衰**：按季节、节气、天干地支确定卦气旺衰（如春旺震巽木），在评分阶段引入季节因子校正号码分布。
* **象数合参**：案例常以卦象（兑为口、巽为股等）解释现实事件，提示在选号时应结合卦象的象义、空间方位与人物属性，以丰富特征。

> 阅读提示：仓促跳过原典容易造成体用、用神缺漏，建议按“起卦 → 动爻 → 互卦 → 五行 → 用神”顺序逐节对照原书，完成配置校准后再启动自动化流程。

## 1. 起卦建模层（Event Encoding Layer）

1. **触发事件采集**：
   * 采集与目标开奖期关联的时间（如投注时间、上期开奖时间、目标期开奖时间）、地点、事件（投注方式、心水号码）等关键信息。
   * 允许在配置中指定优先级，例如：`[投注时间 > 上期开奖号 > 开奖地点]`。
   * 文本起卦案例常以“某年某月某日某时”作为唯一输入，应保留“纯时间起卦”模板，以便对照原书的线下占测流程。
2. **时间数字化规则**：
   * 默认遵循“年月日为上卦，年月日加时为下卦”的累加取余法；实现时需保留可设置的除数（默认 8）与余数映射。
   * 增设“音韵/笔画起卦”插件：对彩票玩法可选用号码读音、投注口令、出票门店名称等文本，按照平上去入四声或笔画计数生成卦数。
   * 支持干支纪时：将天干地支映射到 1-12，再结合纳音五行，为旺衰评估提供输入。
3. **动爻判定**：
   * 遵循原文“上下总数除六，零数定动爻”的基准算法，默认余数 0 视为第六爻动；
   * 扩展动爻策略：如参考投注金额权重、连续开奖差值（载入 `moving_line_policy`），但必须同时记录基准算法结果，作为校验字段
   * 支持多动爻与无动爻（无动爻时默认变爻为互卦）。
4. **数据结构**：
   ```python
   EventSnapshot = TypedDict("EventSnapshot", {
       "timestamp": datetime,
       "location": str,
       "reference_numbers": List[int],
       "custom_factors": Dict[str, Any]
   })

   HexagramSeed = TypedDict("HexagramSeed", {
       "upper_index": int,   # 0-7，对应乾兑离震巽坎艮坤
       "lower_index": int,
       "moving_lines": List[int]  # 1-6
   })
   ```

## 2. 卦象演化层（Hexagram Dynamics Layer）

1. **本卦（体卦）构造**：通过上、下卦索引查表得到先天八卦的阴阳爻分布，标注体卦五行，为体用判别提供依据。
2. **互卦、变卦计算**：
   * 互卦：取主卦第 2-4 爻与第 3-5 爻组成新的上下卦；乾坤无互，需转用变卦。
   * 变卦：对动爻进行阴阳反转，得到趋势卦；若多动爻，保留全组合结果供评分层筛选。
   * 保留卦例注记字段，例如“兑为少女”“巽为股”，支持在特征工程阶段引入象义标签。
3. **数理指标提取**：
   * 五行属性：统计卦象所属五行与旺衰（如春旺震巽），形成 `{主卦, 互卦, 变卦}` 的五行向量及季节加权因子。
   * 世应、六亲：结合用神设置（见下一节）提取关键位，记录“官鬼/财爻/父母”等角色及其旺衰关系。
   * 方位象义：依据卦象方位（坎北、离南等）衍生位置特征，用于约束号码区段或构建聚类标签。
4. **权重分配**：根据玩法特点设定 `{主卦: w1, 互卦: w2, 变卦: w3}`。默认 `[0.5, 0.2, 0.3]`，可在配置中覆盖，并允许根据季节或赛事主题自动调节。

## 3. 数值解码层（Numerical Decoder Layer）

1. **用神、忌神映射**：
   * 依据原典“官鬼父母才兄子”七言口诀，为不同预测目标设定对应六亲。彩票默认以“财爻”为主，用以衡量收益倾向；若研究连号/重号，可引入“兄弟”概念表示重复竞争。
   * 同时保留“末后一笔定用神”的字段，将关键事件（如投注方式、资金来源）的笔画或音韵转换成五行标签，与主用神进行交叉验证。
2. **体用校验**：
   * 在数据结构中标注体卦、用卦及其五行，让评分模型在候选集中优先保留“用神得生”或“体受生”的组合。
   * 对卦象进行旺衰判别（依季节、干支、纳音），若用神衰弱，则触发修正策略（如扩大候选范围或引入互卦补益）。
3. **爻位数值化**：
   * 将六爻自下而上编号 1-6；阴爻记为 0，阳爻记为 1；
   * 形成二进制或十进制编码，例如 `卦值 = Σ(2^(i-1) * 爻值_i)`；
   * 可叠加动爻位序列，形成多特征向量。
4. **数理函数族**：
   * `mod_f(n, base) = (n mod base) + 1`：基础映射。
   * `sum_digits(n)`：用于校验位或蓝球计算；
   * `mirror(n, range_max)`：求补数（例如 33 → 1 映射）。
   * `seasonal_weight(season, element)`：根据卦气旺衰调整号码得分。
5. **候选号码池生成**：
   * 针对每个卦象计算 `卦值`、`动爻值`、`五行加权值`，组合成候选集；
   * 引入“六亲得失”指标：如体卦兄弟旺则考虑拆分连续号码，财爻旺则聚焦高收益区段。
   * 应用去重、排序与阈值过滤。
6. **概率/评分模型**：引入机器学习或统计模型（如权重平均、贝叶斯更新）融合历史开奖频率，形成评分 `score = w_hexagram * hexagram_score + w_history * history_score`。

## 4. 玩法适配层（Game Adapter Layer）

### 4.1 通用接口

```python
class GameAdapter(Protocol):
    name: str
    red_range: Tuple[int, int]
    blue_range: Optional[Tuple[int, int]]
    red_count: int
    blue_count: int

    def transform(self, candidates: List[int], *, phase: str) -> List[int]:
        """按照玩法规则筛选或组合号码。phase 用于区分主区、特别号等。"""

    def post_process(self, selection: Dict[str, List[int]]) -> Dict[str, List[int]]:
        """执行排序、补足、去重等收尾动作。"""
```

适配器接收数值化结果，分主区/特别区两阶段处理。

### 4.2 双色球适配

* **参数**：红球 `1-33` 选 6，蓝球 `1-16` 选 1。
* **策略**：
  1. 将主卦、互卦、变卦得分最高的三个卦值映射到红球范围，分别取 2 个号码；
  2. 若不足 6 个，以动爻序列（如 `moving_line_index * 4 ± 用神修正`) 生成补充；
  3. 蓝球优先使用变卦卦值与互卦卦值的 `sum_digits` 之和取模。

### 4.3 大乐透适配

* **参数**：前区 `1-35` 选 5，后区 `1-12` 选 2。
* **策略**：
  1. 依据权重 `[主:0.4, 互:0.2, 变:0.4]` 对候选集排序，按顺序截取前 5 个；
  2. 引入“互卦对冲”机制：若候选号码集中于同一五行，则调用 `mirror` 生成互补号码；
  3. 后区分别取主卦与变卦卦值的 `mod_f(value, 12)` 结果，若重复则以动爻补齐。

### 4.4 快乐8适配

* **参数**：`1-80` 中任选 10（或其它投注档位）。
* **策略**：
  1. 以主卦卦值为中心，构建等差数列 `value ± k*步长`，步长默认由五行相克程度决定（如金克木 → 步长 5）；
  2. 互卦用于扩散区间，变卦用于确定过滤阈值（如淘汰超出 1-80 范围或重复值）；
  3. 若投注档位少于 10，可通过 `post_process` 随机抽样或按评分截断。

## 5. 结果评估层（Evaluation Layer）

1. **历史对照回测**：
   * 对历史开奖数据批量执行上述流程，记录命中率、位置匹配率、五行分布等指标；
   * 通过可视化（折线图、雷达图）评估参数敏感度。
2. **动态参数迭代**：
   * 使用贝叶斯优化或网格搜索调整时间编码、用神权重、候选过滤阈值；
   * 每次迭代保存配置快照，便于回滚。
3. **风险控制**：
   * 结合资金管理策略（如 Kelly、固定比例）限制投注组合数量；
   * 输出建议投注量与预期收益区间。

## 6. 配置与扩展建议

* **配置文件结构**：
  ```yaml
  event_encoder:
    method: "solar_sum"  # 或 "ganzhi"
    moving_rule: "weighted_amount"
  weights:
    main: 0.5
    mutual: 0.2
    changing: 0.3
  adapters:
    - game: "ssq"
      red_weight: [0.3, 0.2, 0.5]
      blue_rule: "sum_digits"
    - game: "dlt"
      complement_strategy: "mirror"
    - game: "kl8"
      step_rule: "five_element_gap"
  ```
* **可插拔算法**：每个层级都提供策略接口（Strategy Pattern），便于加入机器学习模型、遗传算法等现代方法。
* **日志与可观测性**：推荐在关键节点记录 `EventSnapshot`、卦象与最终选号，方便人工复核与模型改进。

---

该框架强调“传统卦理 → 数学映射 → 玩法约束”的逐层映射方式，可确保不同彩票玩法在统一结构下快速迁移与调参，实现系统化的梅花易数预测流程。

### 附录 A. 原典象数与现代特征映射示例

| 原文摘录 | 卦象含义 | 建议特征/用途 |
| --- | --- | --- |
| “兑为少女……巽为股”——《牡丹占》 | 兑卦主少女、口舌；巽卦主股部、风木 | 在预测女性相关活动或腰腿部位事件时增强兑、巽卦权重；在号码空间内映射“柔性”“变动”特征，用于筛除极端值。 |
| “乾为马也；午时者，离明之象”——《邻夜扣门借物占》 | 乾卦主马匹、首领；离卦主光明、文书 | 对涉及速度、头号球位的预测（如双色球首位）引入乾卦特征；离卦用于判定热点号码或需重点关注的开奖时段。 |
| “升者，有升阶之义……卦中兑为口，坤为腹，为口腹之事”——《今日动静如何》 | 升卦象征升迁；兑卦主口，坤卦主腹 | 在候选号码聚类时增加“晋升/口腹”标签，用于识别需平衡的号码区段（如大小比、奇偶比）。 |
| “五行生克……乾兑金；坤艮土；震巽木；坎水；离火”——《五行生克》 | 八卦对应五行属性及旺衰周期 | 构建 `seasonal_weight`、`element_balance` 指标，定期校正号码五行分布，避免长期偏科。 |

该附录可作为二次建模的知识库起点，后续可扩展更多案例映射，以强化“文本-特征-策略”的闭环验证。
